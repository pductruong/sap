#include "stm32f4xx.h"

void UART2_Init(void) {
    RCC->APB1ENR |= RCC_APB1ENR_USART2EN;
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOAEN;

    GPIOA->MODER &= ~((3 << (2 * 2)) | (3 << (3 * 2)));  // Clear bits
    GPIOA->MODER |= (2 << (2 * 2)) | (2 << (3 * 2));     // AF mode

    GPIOA->AFR[0] &= ~((0xF << (4 * 2)) | (0xF << (4 * 3))); // Clear bits
    GPIOA->AFR[0] |= (7 << (4 * 2)) | (7 << (4 * 3));        // Set AF7

    USART2->BRR = 0x8B;  // (16MHz / 115200) ≈ 138 = 0x8B

    USART2->CR1 = USART_CR1_TE | USART_CR1_UE;
}

void UART2_SendChar(uint8_t c) {
    while (!(USART2->SR & USART_SR_TXE));  // Đợi TXE = 1
    USART2->DR = c;
}

void UART2_SendString(char *str) {
    while (*str) UART2_SendChar(*str++);
}

int main(void) {
    UART2_Init();

    while (1) {
        UART2_SendString("Time: July 29 2025 12:21:46, Temperature: 32.00, Humidity: 71.00%, SoilMoisture: 348, LightLevel: 401, Rainning: 58%, end \n");
        for (volatile int i = 0; i < 1000000; i++); // Delay thô (có thể thay bằng Timer)
    }
}
